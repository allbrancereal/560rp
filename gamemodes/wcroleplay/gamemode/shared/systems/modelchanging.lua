
modelchanger = modelchanger || {}
modelchanger.config = {}


modelchanger.config.female = 1;
modelchanger.config.male   = 2;


modelchanger.config.CameraLookAt = {};
modelchanger.config.CameraLookAt["rp_downtown_2017"] = {};

modelchanger.config.CameraLookAt["rp_downtown_2017"][2] = Vector(-48.64869, 0, 54.05405);
modelchanger.config.CameraLookAt["rp_downtown_2017"][1] = Vector(-100, 10.8110811, 37.8378);
modelchanger.config.CameraLookAt[1] = modelchanger.config.CameraLookAt[1];
modelchanger.config.CameraLookAt[2] = modelchanger.config.CameraLookAt[2];
 
modelchanger.config.CameraCamModelPos = {};
modelchanger.config.CameraCamModelPos["rp_downtown_2017"] = {};
modelchanger.config.CameraCamModelPos["rp_downtown_2017"][2] = Vector(54.05405454, 0, 54.0540); // male
modelchanger.config.CameraCamModelPos["rp_downtown_2017"][1] = Vector(43.24324323, 0, 59.4594559);// female 
 
modelchanger.config.Wardrobes = {

["rp_downtown_tits_v2"] = {

	[1] = {
		PositionOfPlayerCamera	=Vector(110.639801, 35.086441 ,105.03125 );
		AngleOfPlayerCamera		=Angle( -2.5, 88 , 0 );
		PositionOfPlayer		=Vector(107.639801, 140.086441 ,100.03125 );
		AngleOfPlayer			= Angle( 0.000000, -90.000000, 0.000000 );
	};

	[2] = {
		PositionOfPlayerCamera	=Vector(240.383163, 35.611893, 105.03125 );
		AngleOfPlayerCamera		=Angle( -2.5, 88 , 0 );
		PositionOfPlayer		=Vector(236.383163, 140.611893, 100.03125 );
		AngleOfPlayer			= Angle( 0.000000, -90.000000, 0.000000 );
	};

	[3] = {
		PositionOfPlayerCamera	=Vector(360.193207 ,35.239639, 105.03125  );
		AngleOfPlayerCamera		=Angle( -2.5, 88 , 0 );
		PositionOfPlayer		=Vector(356.193207 ,140.239639, 100.03125 );
		AngleOfPlayer			= Angle( 0.000000, -90.000000, 0.000000 );
	};
};
["rp_southside_day"] = {
	
	[1] = {
		PositionOfPlayerCamera =  Vector(-1909.222 , 10760.15 , 220.459 );
		AngleOfPlayerCamera = Angle( 18.814 , -9.332 , 0);
		PositionOfPlayer = Vector(-1833.313 , 10775.096 , 160.031);
		AngleOfPlayer = Angle(4.294 , -160.992 , 0 );		
	};
	[2] = {
		PositionOfPlayerCamera =  Vector(-1925.436 , 10536.118 , 180.031 );
		AngleOfPlayerCamera = Angle( 4.19 , -1.539 , 0  );
		PositionOfPlayer = Vector(-1852.576 , 10558.88 , 128.031 );
		AngleOfPlayer = Angle(1.55 , 179.741 , 0 );		
	};
	[3] = {
		PositionOfPlayerCamera =  Vector(-1925.436 , 10660.118 , 180.031 );
		AngleOfPlayerCamera = Angle( 4.19 , -1.539 , 0  );
		PositionOfPlayer = Vector(-1852.576 , 10682.88 , 128.031 );
		AngleOfPlayer = Angle(1.55 , 179.741 , 0 );		
	};

	[4] = {
		PositionOfPlayerCamera =  Vector(-1881.76 , 10410.997 , 180.031 );
		AngleOfPlayerCamera = Angle( 6.169 , -91.054 , 0 );
		PositionOfPlayer = Vector(-1861.086 , 10344.031 , 132.031);
		AngleOfPlayer = Angle(5.619 , 89.206 , 0  );		
	};

};
["rp_downtown_v4c_v2"] = {
	[1] = {
		PositionOfPlayerCamera =  Vector(-135.867 , 260.126 , -20.969 );
		AngleOfPlayerCamera = Angle( -2.5, 180 , 0 );
		PositionOfPlayer = Vector(-213.037 , 230.271 , -63.969 );
		AngleOfPlayer = Angle( 0.000000, 0.000000, 0.000000 );		
	};
	[2] = {
		PositionOfPlayerCamera =  Vector(-135.867 , 230.126 , -20.969 );
		AngleOfPlayerCamera = Angle( -2.5, 0 , 0 );
		PositionOfPlayer = Vector(-52.722 , 260.953 , -63.969 );
		AngleOfPlayer = Angle( 0.000000, -180.000000, 0.000000 );		
	};
	
	[3] = {
		PositionOfPlayerCamera =  Vector(-135.867 , 260.126 , 103.969 );
		AngleOfPlayerCamera = Angle( -2.5, 180 , 0 );
		PositionOfPlayer = Vector(-213.037 , 230.271 , 63.969 );
		AngleOfPlayer = Angle( 0.000000, 0.000000, 0.000000 );		
	};
	[4] = {
		PositionOfPlayerCamera =  Vector(-135.867 , 230.126 , 103.969 );
		AngleOfPlayerCamera = Angle( -2.5, 0 , 0 );
		PositionOfPlayer = Vector(-52.722 , 260.953 , 63.969 );
		AngleOfPlayer = Angle( 0.000000, -180.000000, 0.000000 );		
	};

};
["rp_downtown_2017"] = {
	[1] = {
		PositionOfPlayerCamera = Vector( -1350.903198, 1020.754761, 45.22576 );
		AngleOfPlayerCamera = Angle( 0, 55 , 0 );
		PositionOfPlayer = Vector(-1335.866455, 1080.707275, 4.371845 );
		AngleOfPlayer = Angle( 0.000000, -90.000000, 0.000000 );
			
	};	
	[2] = {
		PositionOfPlayerCamera = Vector( -1250.903198, 1020.754761, 45.22576 );
		AngleOfPlayerCamera = Angle( 0, 55 , 0 );
		PositionOfPlayer = Vector( -1225.866455, 1080.707275, 4.371845 );
		AngleOfPlayer = Angle( 0.000000, -90.000000, 0.000000 );
			
	};
	[3] = {
		PositionOfPlayerCamera = Vector( -1150.903198, 1020.754761, 45.22576 );
		AngleOfPlayerCamera = Angle( 0, 55 , 0 );
		PositionOfPlayer = Vector(-1125.866455, 1080.707275, 4.371845 );
		AngleOfPlayer = Angle( 0.000000, -90.000000, 0.000000 );
			
	};
	[4] = {
		PositionOfPlayerCamera = Vector( -1050.903198, 1020.754761, 45.22576 );
		AngleOfPlayerCamera = Angle( 0, 55 , 0 );
		PositionOfPlayer = Vector(-1025.866455, 1080.707275, 4.371845 );
		AngleOfPlayer = Angle( 0.000000, -90.000000, 0.000000 );
			
	};
};
["rp_evocity_v33x"] = {
	// done 
	
	[4] = {
		PositionOfPlayerCamera	= Vector( -4970.008301, -6115.685547, 260.50326 );
		AngleOfPlayerCamera		= Angle( 10, 0 , 0 );
		PositionOfPlayer		= Vector( -4910.008301, -6096.685547, 220.50326 );
		AngleOfPlayer			= Angle( 0.000000, -180.000000, 0.000000 );
	};
	
	[3] = {
		PositionOfPlayerCamera	= Vector( -4970.008301, -5930.685547, 260.50326 );
		AngleOfPlayerCamera		= Angle( 10, 0 , 0 );
		PositionOfPlayer		= Vector( -4910.008301, -5920.685547, 220.50326 );
		AngleOfPlayer			= Angle( 0.000000, -180.000000, 0.000000 );
	};
	
	[2] = {
		PositionOfPlayerCamera	= Vector(  -4975.505859, -5940.845703, 125.50326 );
		AngleOfPlayerCamera		= Angle( 10, 90, 0 );
		PositionOfPlayer		= Vector( -5000.008301, -5882.685547, 100.50326 );
		AngleOfPlayer			= Angle( 0.000000, -90.000000, 0.000000 );
	};
	
	[5] = {
		PositionOfPlayerCamera	= Vector(  -5150.505859, -5940.845703, 125.50326 );
		AngleOfPlayerCamera		= Angle( 10, 90, 0 );
		PositionOfPlayer		= Vector( -5175.008301, -5882.685547, 100.50326 );
		AngleOfPlayer			= Angle( 0.000000, -90.000000, 0.000000 );
	};
	
	
	
	[1] = {
		PositionOfPlayerCamera	= Vector(  -5275.505859, -5940.845703, 125.50326 );
		AngleOfPlayerCamera		= Angle( 10, 90, 0 );
		PositionOfPlayer		= Vector( -5300.008301, -5882.685547, 100.50326 );
		AngleOfPlayer			= Angle( 0.000000, -90.000000, 0.000000 );
	};
	
	/*
	[1] = {
		PositionOfPlayerCamera	=
		AngleOfPlayerCamera		=
		PositionOfPlayer		=
		AngleOfPlayer			= Angle( 0.000000, -90.000000, 0.000000 );
	}
	*/
};
	
}
modelchanger.config.AnimationSequences = {
				"pose_standing_02", 
				"pose_standing_03",
 
 } 
local _pMeta = FindMetaTable( 'Player' )

function _pMeta:IsInModelShop()

	return self:getFlag( "model_viewOverride", false )
	
end

if SERVER then

	util.AddNetworkString("modelchanger_UI")
	util.AddNetworkString("modelchanger_sendExit")
	
	util.AddNetworkString("modelchange_UpdateBodygroups")
	util.AddNetworkString("modelchange_UpdateSkin")
	util.AddNetworkString("modelchanger_updatePlayerModel")
	util.AddNetworkString("modelchange_buyCart")
	
	net.Receive( "modelchanger_updatePlayerModel" , function ( _len , _p )
	
		local _model = net.ReadString()
		

		_p:SetModel( player_manager.TranslatePlayerModel( _model ) )
		
		_p:SetSkin( 0 )
			
		for k = 0, _p:GetNumBodyGroups() - 1 do
				
			_p:SetBodygroup( k, 0 )
			
		end
		
		_p:getFlag("createacharacter_playerModel_cart", "Vindictus-Vella" )
		_p:getFlag("createacharacter_bodygroups_cart", "" ) 
		_p:getFlag("createacharacter_bodySkin_cart", 0 )	
		
	end ) 
	
	net.Receive( "modelchange_buyCartRemote" , function( _len , _p )
		
			local _name = net.ReadString( )
			local _skin = 0
			local _bdg = ""
			
			if !_p:IsOnQuest( 2 ) then
	
				_p:RewardQuest( 2 );
				
			end
			_p:ConCommand("stopsound")
			
			local _toPay = fsrp.config.FacialCost;
			_toPay = _toPay * 2;
			
			local ply = _p;
			
			if !ply:IsPremium() then
				if ply:canAffordBank( _toPay ) && ply:getBankAccount() > 0 then
					
					ply:addBank( -_toPay )
				
					ply:Notify("Your bank has been charged for this facial treatment. (+100% because of remote access) ");
					
				else
				
					ply:Notify("You can not afford this facial treatment, ($" .. _toPay .. ")");
					return
					
				end		
			else
			
				ply:Notify("You have been given a free model change. Thank you for supporting WestCoastRP!")
				
			end
			
			if ply:IsDonator() && !ply:IsPremium() then
			
				_toPay = _toPay/2
				
				ply:Notify("You have been given a 50% off model change. Thank you for supporting WestCoastRP!")
				
			end
			//_p:Notify( player_manager.TranslatePlayerModel( _name ) )
			//_p:Notify( _bdg )
			//_p:Notify( _skin )
			
			_p:SetModel( player_manager.TranslatePlayerModel( _name ) )
			local groups = _bdg
			if ( groups == nil ) then groups = "" end
			local groups = string.Explode( " ", groups )
			for k = 0, _p:GetNumBodyGroups() - 1 do
				_p:SetBodygroup( k, tonumber( groups[ k + 1 ] ) or 0 )
			end
			
			_p:SetSkin( _skin )
			timer.Simple( 0.2, function()
				local hands = _p:GetHands()
				if ( IsValid( hands ) ) then 
					-- Which hands should we use?
					local info = player_manager.TranslatePlayerHands( mdl )
					if ( info ) then
						hands:SetModel( info.model )
						hands:SetSkin( _skin )
						hands:SetBodyGroups( info.body )
					end
					-- Attach them to the viewmodel
					local vm = _p:GetViewModel( 0 )
					hands:AttachToViewmodel( vm )
					vm:DeleteOnRemove( hands )
					_p:DeleteOnRemove( hands )
				end
			end )
			local _team = _p:Team()
			
			if _team == TEAM_POLICE then
			
				_p:setFlag("playerinfo_job_police_model", _name )
				_p:setFlag("playerinfo_job_police_bodygroups", _bdg )
				_p:setFlag("playerinfo_job_police_skin", _skin )
		
			
			elseif _team == TEAM_PARAMEDIC then
						
				_p:setFlag("playerinfo_job_paramedic_model", _name )
				_p:setFlag("playerinfo_job_paramedic_bodygroups", _bdg )
				_p:setFlag("playerinfo_job_paramedic_skin", _skin )
			elseif _team == TEAM_MAYOR then
			
				_p:setFlag("playerinfo_job_mayor_model",  _name  )
				_p:setFlag("playerinfo_job_mayor_bodygroups", _bdg )
				_p:setFlag("playerinfo_job_mayor_skin",  _skin )
			
			
			elseif _team == TEAM_CIVILLIAN then 
				
				_p:setFlag("playerinfo_model", _name )
				_p:setFlag("playerinfo_bodygroups", _bdg )
				_p:setFlag("playerinfo_skin", _skin )
		
			end
			
			_p:SaveGMModels()
	
			//net.Start("UpdateHUD")
			//net.Send( _p )
					
	end )
	net.Receive( "modelchange_buyCart" , function( _len , _p )
		
			local _name = net.ReadString( )
			local _skin = net.ReadInt( 8 )
			local _bdg = net.ReadString( )
			local _hatV = net.ReadVector()
			local _hatAng = net.ReadAngle()
			
			if !_p:IsOnQuest( 2 ) then
	
				_p:RewardQuest( 2 );
				
			end
			_p:GodDisable()
			_p:ConCommand("stopsound")
			
			local _toPay = fsrp.config.FacialCost;
			
			local ply = _p;
			
			if !ply:IsPremium() then
				if ply:canAfford( _toPay ) then
				
					ply:addMoney( -_toPay )
					
					ply:Notify("You have paid with cash for this facial treatment.");
					
				elseif ply:canAffordBank( _toPay ) && ply:getBankAccount() > 0 then
					
					ply:addBank( -_toPay )
				
					ply:Notify("Your bank has been charged for this facial treatment.");
					
				else
						ply:Notify("You can not afford this facial treatment, ($" .. _toPay .. ")");
						return
					
				end		
			else
			
				ply:Notify("You have been given a free model change. Thank you for supporting WestCoastRP!")
				
			end
			
			if ply:IsDonator() && !ply:IsPremium() then
			
				_toPay = _toPay/2
				
				ply:Notify("You have been given a 50% off model change. Thank you for supporting WestCoastRP!")
				
			end
			
			_p:setFlag("hatPYR", _hatAng );
			_p:setFlag("hatXYZ", _hatV );
			
			_p:SaveHatCoordinateEntry()
			//_p:Notify( player_manager.TranslatePlayerModel( _name ) )
			//_p:Notify( _bdg )
			//_p:Notify( _skin )
			
			_p:SetModel( player_manager.TranslatePlayerModel( _name ) )
			local groups = _bdg
			if ( groups == nil ) then groups = "" end
			local groups = string.Explode( " ", groups )
			for k = 0, _p:GetNumBodyGroups() - 1 do
				_p:SetBodygroup( k, tonumber( groups[ k + 1 ] ) or 0 )
			end
			
			_p:SetSkin( _skin )
			timer.Simple( 0.2, function()
				local hands = _p:GetHands()
				if ( IsValid( hands ) ) then 
					-- Which hands should we use?
					local info = player_manager.TranslatePlayerHands( mdl )
					if ( info ) then
						hands:SetModel( info.model )
						hands:SetSkin( _skin )
						hands:SetBodyGroups( info.body )
					end
					-- Attach them to the viewmodel
					local vm = _p:GetViewModel( 0 )
					hands:AttachToViewmodel( vm )
					vm:DeleteOnRemove( hands )
					_p:DeleteOnRemove( hands )
				end
			end )
			local _team = _p:Team()
			
			if _team == TEAM_POLICE then
			
				_p:setFlag("playerinfo_job_police_model", _name )
				_p:setFlag("playerinfo_job_police_bodygroups", _bdg )
				_p:setFlag("playerinfo_job_police_skin", _skin )
		
			
			elseif _team == TEAM_PARAMEDIC then
						
				_p:setFlag("playerinfo_job_paramedic_model", _name )
				_p:setFlag("playerinfo_job_paramedic_bodygroups", _bdg )
				_p:setFlag("playerinfo_job_paramedic_skin", _skin )
			elseif _team == TEAM_MAYOR then
			
				_p:setFlag("playerinfo_job_mayor_model",  _name  )
				_p:setFlag("playerinfo_job_mayor_bodygroups", _bdg )
				_p:setFlag("playerinfo_job_mayor_skin",  _skin )
			
			
			elseif _team == TEAM_CIVILLIAN then 
				
				_p:setFlag("playerinfo_model", _name )
				_p:setFlag("playerinfo_bodygroups", _bdg )
				_p:setFlag("playerinfo_skin", _skin )
		
			end
			
			_p:SaveGMModels()
	
			//net.Start("UpdateHUD")
			//net.Send( _p )
					
	end )
	
	function _pMeta:SaveGMModels()
	
		local _p = self;
		
		local _civillian_model		= _p:getFlag( "playerinfo_model", "Vindictus-Vella" )
		local _civillian_bdg		= _p:getFlag( "playerinfo_bodygroups", "" )
		local _civillian_skin		= _p:getFlag( "playerinfo_skin", 0 )
		local _police_model			= _p:getFlag( "playerinfo_job_police_model", "Police_4" )
		local _police_bdg			= _p:getFlag( "playerinfo_job_police_bodygroups", "" )
		local _police_skin			= _p:getFlag( "playerinfo_job_police_skin", 0 )
		local _paramedic_model		= _p:getFlag( "playerinfo_job_paramedic_model", "hospitalfemale_1" )
		local _paramedic_bdg		= _p:getFlag( "playerinfo_job_paramedic_bodygroups", "" )
		local _paramedic_skin		= _p:getFlag( "playerinfo_job_paramedic_skin", 0)
		local _mayor_model		= _p:getFlag( "playerinfo_job_mayor_model", "Liz(11 Noire)" )
		local _mayor_bodygroups		= _p:getFlag( "playerinfo_job_mayor_bodygroups", "" )
		local _mayor_skin		= _p:getFlag( "playerinfo_job_mayor_skin", 0)
		
		fsdb:Query("UPDATE fsdb_models SET  `mayor_skin`= '".. _mayor_skin .."',  `mayor_bodygroups`= '".. _mayor_bodygroups .."',  `mayor`= '".. _mayor_model .."', `citizen_model`='" .. _civillian_model .. "', `citizen_skin`=" .. _civillian_skin .. ", `citizen_bodygroups`='" .. _civillian_bdg .. "', `police`='" .. _police_model .. "' , `police_skin`=" .. _police_skin .. ", `police_bodygroups`='" .. _police_bdg .. "', `paramedic`='" .. _paramedic_model .. "', `paramedic_skin`=" .. _paramedic_skin .. ", `paramedic_bodygroups`='" .. _paramedic_bdg .. "' WHERE `steamid`='" .. _p:SteamID() .. "';");

	
		net.Start("UpdateHUD")
		net.Send( self )
		
		timer.Simple( 3, function() 
		
			self:LoadGMModels()
	
		end)
	end
	
	function _pMeta:LoadGMModels()
	
		local _p = self;
		local _defaultParam = "hospitalfemale_1";
			local DefaultMayor = "Liz(11 Noire)";
		
		if _p:getGender() != 1 then
		
			_defaultParam = "hospitalmale_1"
				DefaultMayor = "breen"
			
		end
		
		local _civillian_model		= _p:getFlag( "playerinfo_model", "Vindictus-Vella" )
		local _civillian_bdg		= _p:getFlag( "playerinfo_bodygroups", "" )
		local _civillian_skin		= _p:getFlag( "playerinfo_skin", tostring(0) )
		local _police_model			= _p:getFlag( "playerinfo_job_police_model", "Police_4" )
		local _police_bdg			= _p:getFlag( "playerinfo_job_police_bodygroups", "" )
		local _police_skin			= _p:getFlag( "playerinfo_job_police_skin",  tostring(0) )
		local _paramedic_model		= _p:getFlag( "playerinfo_job_paramedic_model", _defaultParam )
		local _paramedic_bdg		= _p:getFlag( "playerinfo_job_paramedic_bodygroups", "" )
		local _paramedic_skin		= _p:getFlag( "playerinfo_job_paramedic_skin",  tostring(0))
		local _mayor_model		= _p:getFlag( "playerinfo_job_mayor_model", DefaultMayor )
		local _mayor_bodygroups		= _p:getFlag( "playerinfo_job_mayor_bodygroups", "" )
		local _mayor_skin		= _p:getFlag( "playerinfo_job_mayor_skin",  tostring(0))
		
		tmysqlReroute( "SELECT  `citizen_model`, `citizen_skin`, `citizen_bodygroups`, `police` , `police_skin`, `police_bodygroups`, `paramedic`, `paramedic_skin`, `paramedic_bodygroups`, `mayor`, `mayor_skin`, `mayor_bodygroups` FROM `fsdb_models` WHERE `steamid`='" .. self:SteamID() .. "';" , function ( _,result )
			
			
			if !result || !result[1] || !result[1]["citizen_model"] then
			
			
				fsdb:Query( "INSERT INTO `fsdb_models` VALUES ( 0,'', '" .. self:SteamID() .. "' , '" .. _civillian_model .. "', '" .. _civillian_skin .. "', '" .. _civillian_bdg .. "', '" .. _police_model .. "','" .. _police_skin .. "', '" .. _police_bdg .. "', '" .. _paramedic_model .. "', '" .. _paramedic_skin .. "','" .. _paramedic_bdg.. "','" .. _mayor_model .. "', '" .. _mayor_skin .. "','" .. _mayor_bodygroups.. "' );  " )
	
						
				
			else	

				local data = {
					[1] = {
						[1] = result[1]["citizen_model"];
						[2] = result[1]["citizen_skin"];
						[3] = result[1]["citizen_bodygroups"];
						[4] = result[1]["police"];
						[5] = result[1]["police_skin"];
						[6] = result[1]["police_bodygroups"];
						[7] = result[1]["paramedic"];
						[8] = result[1]["paramedic_skin"];
						[9] = result[1]["paramedic_bodygroups"];
						[10] = result[1]["mayor"];
						[11] = result[1]["mayor_skin"];
						[12] = result[1]["mayor_bodygroups"];
					}
				}
				local _row = data[1];		
			
				_p:setFlag("playerinfo_job_police_model", _row[4] )
				_p:setFlag("playerinfo_job_police_bodygroups",  _row[6]  )
				_p:setFlag("playerinfo_job_police_skin",  tonumber( _row[5] )  )
		
			
						
				_p:setFlag("playerinfo_job_paramedic_model",  _row[7]  )
				_p:setFlag("playerinfo_job_paramedic_bodygroups",  _row[9]  )
				_p:setFlag("playerinfo_job_paramedic_skin",  tonumber( _row[8] ) )
			
				local DefaultMayor = "Liz(11 Noire)";
				if _p:getGender() == 2 then
				
					DefaultMayor = "breen"
					
				end
				if _row[10] && _row[12] && _row[11] then
					
					_p:setFlag("playerinfo_job_mayor_model",  _row[10]  )
					_p:setFlag("playerinfo_job_mayor_bodygroups",  _row[12] )
					_p:setFlag("playerinfo_job_mayor_skin",  tonumber( _row[11] ) )
					
				else
						
						
					_p:setFlag("playerinfo_job_mayor_model",  DefaultMayor  )
					_p:setFlag("playerinfo_job_mayor_bodygroups",  ""  )
					_p:setFlag("playerinfo_job_mayor_skin",  0 )
				end
				
				_p:setFlag("playerinfo_model",  _row[1]  )
				_p:setFlag("playerinfo_bodygroups",  _row[3]  )
				_p:setFlag("playerinfo_skin",  tonumber( _row[2] ) )
			
			
				local _job = "";

				
				if _p:Team() == TEAM_POLICE then
					
					_job = "job_police_";
				
				elseif _p:Team() == TEAM_PARAMEDIC then
				
					
					_job = "job_paramedic_";
					
				elseif _p:Team() == TEAM_MAYOR then
				
					_job = "job_mayor_";
					
				end
				local _model		= _p:getFlag( "playerinfo_".. _job .."model", "hospitalfemale_1" )
				local _bdg		= _p:getFlag( "playerinfo_".. _job .."bodygroups", "" )
				local _skin		= _p:getFlag( "playerinfo_".. _job .."skin", 0)
				
				_p:SetModel( player_manager.TranslatePlayerModel( _model ) )
				
				local groups = _bdg
				
				if ( groups == nil ) then groups = "" end
				
				local groups = string.Explode( " ", groups )
				
				for k = 0, _p:GetNumBodyGroups() - 1 do
				
					_p:SetBodygroup( k, tonumber( groups[ k + 1 ] ) or 0 )
					
				end
				
				_p:SetSkin( tonumber( _skin or 0 ) );
				
				timer.Simple( 0.2, function()
				
					local hands = _p:GetHands()
					
					if ( IsValid( hands ) ) then 
						
						local info = player_manager.TranslatePlayerHands( mdl )
						
						if ( info ) then
						
							hands:SetModel( info.model )
							
							hands:SetSkin( tonumber( _row[2] or 0 ) )
							
							hands:SetBodyGroups( info.body )
							
						end
						
						local vm = _p:GetViewModel( 0 )
						
						hands:AttachToViewmodel( vm )
						
						vm:DeleteOnRemove( hands )
						
						_p:DeleteOnRemove( hands )
						
					end
					
				end )
			
			end
			
		end )
		
		
	end
	util.AddNetworkString("sendClientHatAdjustment")
	util.AddNetworkString("defaulthatCoords")
	net.Receive("defaulthatCoords",function(_l,_p)
			
		local _shouldresetAng =	net.ReadBool()
		if !_shouldresetAng then
		
			_p:setFlag("hatXYZ", _p:getFlag("hatXYZ",Vector(0,0,0)) )
		
			return
		end
		
		_p:setFlag("hatPYR", _p:getFlag("hatPYR",Angle(0,0,0)) )
	end)
	net.Receive( "modelchange_UpdateBodygroups", function( _len , _p )
	
		local _Value =  net.ReadInt( 8 )
		local _TypeBody = net.ReadInt( 8 )
		
		_p:SetBodygroup( _TypeBody , _Value )
	
	end )
	
	net.Receive( "modelchange_UpdateSkin", function( _len, _p )
	
		local _skin = net.ReadInt(8)
		
		_p:SetSkin( _skin );	
	
	end )
	
	net.Receive( "modelchanger_sendExit" , function( len, _p )
	
		_p:ExitModelShop()	
		//if _p:getFlag("HatEquiped", false) then return end
		_p:setFlag("hatXYZ", _p:getFlag("hatXYZ",Vector(0,0,0)) )
		_p:setFlag("hatPYR", _p:getFlag("hatPYR",Angle(0,0,0)) )
		
		net.Start("sendClientHatAdjustment")
			net.WriteVector(  _p:getFlag("hatXYZ",Vector(0,0,0)) )
			net.WriteAngle(  _p:getFlag("hatPYR",Angle(0,0,0)) )
			net.WriteString( _p:SteamID() )

		if #player.GetAll() > 0 then
			net.Broadcast()
		end
		
	end )
	
	
end
function IsWardrobeOccupied( id )

	
	local _Occupancy = false;
	for k , v in pairs( player.GetAll() ) do
	
		if v:getFlag("modelshop_WardrobeBooth", 0 ) == id then
		
			_Occupancy = true;
			
		end
		
	end
	
	return _Occupancy;
	
end

function _pMeta:EnterModelShop( )
	if !modelchanger.config.Wardrobes[game.GetMap()]  then return end
	self:GodEnable()
	local _toIndex = 0;
	for i = 1 , #modelchanger.config.Wardrobes[game.GetMap()] do
		
		if !IsWardrobeOccupied( i ) then
		
			_toIndex = i;
			break
		else
			continue
		
		end
		
	end
	
	if _toIndex <= 0 then return self:Notify( "No wardrobes available, wait up for other people" ) end
	
	self:setFlag("modelshop_WardrobeBooth", _toIndex );
	self:setFlag( "model_viewOverride", true )
		
	if SERVER then
		
		self:SelectWeapon( "keys" )
		
		self:setFlag( "modelchanger_PreviousLocation" , self:GetPos( ) )
		
		self:SetPos( modelchanger.config.Wardrobes[game.GetMap()][_toIndex].PositionOfPlayer )
		self:SetEyeAngles( modelchanger.config.Wardrobes[game.GetMap()][_toIndex].AngleOfPlayer )
		//PrintTable( self:GetSequenceList() )
		
		self:SendModelChangeUI()
		self:SelectWeightedSequence( ACT_COVER ) 
	end
	
end



function _pMeta:SendModelChangeUI( bool )
	if !SERVER then return end
	if !bool then bool = false; end
	
	net.Start( "modelchanger_UI" )
		net.WriteBool( bool )
		//net.WriteString( modelchanger.config.AnimationSequences[ math.random( #modelchanger.config.AnimationSequences ) ]  )
	net.Send( self )
		
end

if CLIENT then

	net.Receive( "modelchanger_UI", function( _len, _p )
		local _toDo = net.ReadBool();
		
		if !_toDo then
			
			ply:setFlag( "modelchanger_nextAnimTime", CurTime() + 5 )
			ply:AnimRestartGesture( GESTURE_SLOT_CUSTOM, ACT_GMOD_GESTURE_BOW, true )
			
			OpenModelChangingMenu()
	
		end
	
	end )

end

modelchanger.config.actTable = {
	{ delay = 15,  act = ACT_GMOD_TAUNT_ROBOT};
	{ delay = 15,  act = ACT_GMOD_TAUNT_DANCE};
	{ delay = 30,  act = ACT_GMOD_TAUNT_MUSCLE};
	{ delay = 5,  act = ACT_GMOD_GESTURE_BOW};
	{ delay = 5,  act = ACT_GMOD_GESTURE_AGREE};
	{ delay = 5,  act = ACT_GMOD_GESTURE_BECON};
	{ delay = 5,  act = ACT_GMOD_GESTURE_BOW};
}

hook.Add("CalcMainActivity", "modelchange_animations", function(ply, velocity) 
		
		if ply:IsInModelShop() && CurTime() > ply:getFlag("modelchanger_nextAnimTime" , 0 ) then
		//if ply:IsInModelShop() then
			local _random = modelchanger.config.actTable[ math.random( #modelchanger.config.actTable )]
			//print( _random )
			ply:AnimRestartGesture( GESTURE_SLOT_CUSTOM, _random.act, true )
			ply:setFlag( "modelchanger_nextAnimTime", CurTime() + _random.delay )
			
		end
	
		
	
end )

if SERVER then

function _pMeta:ExitModelShop( )
	self:setFlag("modelshop_WardrobeBooth", 0 );

	self:setFlag( "model_viewOverride", false )
	
	self:SetPos( self:getFlag("modelchanger_PreviousLocation", Vector( -1084.348633, 716.321716 ,95.68 ) ) )
	
	
		local _job = "";
	if self:Team() == TEAM_POLICE then
		
		_job = "job_police_";
	
	elseif self:Team() == TEAM_PARAMEDIC then
	
		
		_job = "job_paramedic_";
		
	elseif self:Team() == TEAM_MAYOR then
	
	
		_job = "job_mayor_";
		
	end
		local _model		= self:getFlag( "playerinfo_".. _job .."model", "hospitalfemale_1" )
		local _bdg		= self:getFlag( "playerinfo_".. _job .."bodygroups", "" )
		local _skin		= self:getFlag( "playerinfo_".. _job .."skin", 0)
				
				self:SetModel( player_manager.TranslatePlayerModel( _model ) )
				
				local groups = _bdg
				
				if ( groups == nil ) then groups = "" end
				
				local groups = string.Explode( " ", groups )
				
				for k = 0, self:GetNumBodyGroups() - 1 do
				
					self:SetBodygroup( k, tonumber( groups[ k + 1 ] ) or 0 )
					
				end
				
				self:SetSkin( tonumber( _skin or 0 ) );
				
				timer.Simple( 0.2, function()
				
					local hands = self:GetHands()
					
					if ( IsValid( hands ) ) then 
						
						local info = player_manager.TranslatePlayerHands( mdl )
						
						if ( info ) then
						
							hands:SetModel( info.model )
							
							hands:SetSkin( tonumber( _row[2] or 0 ) )
							
							hands:SetBodyGroups( info.body )
							
						end
						
						local vm = self:GetViewModel( 0 )
						
						hands:AttachToViewmodel( vm )
						
						vm:DeleteOnRemove( hands )
						
						self:DeleteOnRemove( hands )
						
					end
					
				end )
				
end

end